<% layout("/layouts/boilerplate") %>

<div class="trip-planner-container">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Header -->
                <div class="planner-header text-center mb-5">
                    <h1><i class="fa-solid fa-route me-3"></i>Plan Your Perfect Trip</h1>
                    <p class="lead">Get instant budget estimates and create your dream vacation</p>
                </div>

                <!-- Trip Planning Form -->
                <div class="trip-form-card">
                    <form id="tripPlannerForm" data-ajax="true">
                        <div class="row">
                            <!-- Destination -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label">
                                    <i class="fa-solid fa-map-marker-alt me-2"></i>Destination
                                </label>
                                <input type="text" class="form-control" id="destination" 
                                       value="<%= preselectedDestination %>" 
                                       placeholder="Where do you want to go?" required>
                            </div>

                            <!-- Departure City -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label">
                                    <i class="fa-solid fa-plane-departure me-2"></i>From
                                </label>
                                <input type="text" class="form-control" id="departureCity" 
                                       placeholder="Your departure city" required>
                            </div>

                            <!-- Start Date -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label">
                                    <i class="fa-solid fa-calendar-alt me-2"></i>Start Date
                                </label>
                                <input type="date" class="form-control" id="startDate" required>
                            </div>

                            <!-- End Date -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label">
                                    <i class="fa-solid fa-calendar-check me-2"></i>End Date
                                </label>
                                <input type="date" class="form-control" id="endDate" required>
                            </div>

                            <!-- Number of Travelers -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label">
                                    <i class="fa-solid fa-users me-2"></i>Travelers
                                </label>
                                <select class="form-select" id="travelers" required>
                                    <option value="1">1 Person</option>
                                    <option value="2" selected>2 People</option>
                                    <option value="3">3 People</option>
                                    <option value="4">4 People</option>
                                    <option value="5">5+ People</option>
                                </select>
                            </div>

                            <!-- Budget Type -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label">
                                    <i class="fa-solid fa-wallet me-2"></i>Budget Type
                                </label>
                                <select class="form-select" id="budgetType" required>
                                    <option value="budget">üí∞ Budget (Economy) - $50-100/day</option>
                                    <option value="moderate" selected>üè® Moderate (Comfort) - $100-200/day</option>
                                    <option value="luxury">‚ú® Luxury (Premium) - $200+/day</option>
                                </select>
                            </div>

                            <!-- Currency Selection -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label">
                                    <i class="fa-solid fa-dollar-sign me-2"></i>Currency
                                </label>
                                <select class="form-select" id="currency">
                                    <option value="USD" selected>üá∫üá∏ USD - US Dollar</option>
                                    <option value="EUR">üá™üá∫ EUR - Euro</option>
                                    <option value="GBP">üá¨üáß GBP - British Pound</option>
                                    <option value="INR">üáÆüá≥ INR - Indian Rupee</option>
                                </select>
                            </div>

                            <!-- Trip Type -->
                            <div class="col-md-6 mb-4">
                                <label class="form-label">
                                    <i class="fa-solid fa-map me-2"></i>Trip Type
                                </label>
                                <select class="form-select" id="tripType">
                                    <option value="leisure" selected>üèñÔ∏è Leisure/Vacation</option>
                                    <option value="business">üíº Business Travel</option>
                                    <option value="adventure">üèîÔ∏è Adventure/Outdoor</option>
                                    <option value="cultural">üèõÔ∏è Cultural/Heritage</option>
                                    <option value="romantic">üíï Romantic Getaway</option>
                                </select>
                            </div>
                        </div>

                        <!-- Advanced Options Toggle -->
                        <div class="col-12 mb-3">
                            <button type="button" class="btn btn-outline-info btn-sm" id="toggleAdvanced">
                                <i class="fa-solid fa-cog me-1"></i>
                                Advanced Options
                            </button>
                        </div>

                        <!-- Advanced Options (Hidden by default) -->
                        <div id="advancedOptions" class="row" style="display: none;">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fa-solid fa-bed me-2"></i>Accommodation Preference
                                </label>
                                <select class="form-select" id="accommodation">
                                    <option value="hotel">üè® Hotel</option>
                                    <option value="hostel">üè† Hostel</option>
                                    <option value="airbnb">üè° Airbnb/Rental</option>
                                    <option value="resort">üèñÔ∏è Resort</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">
                                    <i class="fa-solid fa-utensils me-2"></i>Meal Plan
                                </label>
                                <select class="form-select" id="mealPlan">
                                    <option value="self">üç≥ Self-catered</option>
                                    <option value="mixed" selected>üçΩÔ∏è Mixed (restaurants + cooking)</option>
                                    <option value="restaurants">üç¥ Restaurants only</option>
                                    <option value="all-inclusive">üçæ All-inclusive</option>
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg me-3">
                                <i class="fa-solid fa-calculator me-2"></i>
                                Get Smart Estimate
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg" id="resetForm">
                                <i class="fa-solid fa-refresh me-2"></i>
                                Reset
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="text-center mt-4" style="display: none;">
                    <div class="loading-animation">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="loading-steps mt-3">
                            <p id="loadingStep">üîç Searching for best flight deals...</p>
                            <div class="progress mt-2">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" id="loadingProgress"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="mt-5" style="display: none;">
                    <div class="results-card">
                        <div class="results-header text-center mb-4">
                            <h3><i class="fa-solid fa-chart-pie me-2"></i>Your Smart Trip Estimate</h3>
                            <div class="total-cost">
                                <span class="currency" id="currencySymbol">$</span>
                                <span id="totalAmount">0</span>
                                <small class="text-muted d-block">Total for <span id="resultTravelers">2</span> travelers</small>
                                <small class="text-muted d-block">‚âà <span id="perPersonAmount">0</span> per person</small>
                            </div>
                            <div class="seasonal-info mt-2">
                                <span class="badge bg-info" id="seasonalBadge" style="display: none;">
                                    <i class="fa-solid fa-calendar-alt me-1"></i>
                                    Seasonal pricing applied
                                </span>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Cost Breakdown -->
                            <div class="col-lg-6">
                                <div class="cost-breakdown">
                                    <h5 class="mb-3">Detailed Cost Breakdown</h5>
                                    <div class="cost-item">
                                        <div class="cost-label">
                                            <i class="fa-solid fa-plane text-primary"></i>
                                            Flights
                                            <small class="percentage" id="flightPercentage">0%</small>
                                        </div>
                                        <div class="cost-value"><span id="currencySymbol2">$</span><span id="flightCost">0</span></div>
                                    </div>
                                    <div class="cost-item">
                                        <div class="cost-label">
                                            <i class="fa-solid fa-bed text-success"></i>
                                            Hotels
                                            <small class="percentage" id="hotelPercentage">0%</small>
                                        </div>
                                        <div class="cost-value"><span id="currencySymbol3">$</span><span id="hotelCost">0</span></div>
                                    </div>
                                    <div class="cost-item">
                                        <div class="cost-label">
                                            <i class="fa-solid fa-utensils text-warning"></i>
                                            Food & Dining
                                            <small class="percentage" id="foodPercentage">0%</small>
                                        </div>
                                        <div class="cost-value"><span id="currencySymbol4">$</span><span id="foodCost">0</span></div>
                                    </div>
                                    <div class="cost-item">
                                        <div class="cost-label">
                                            <i class="fa-solid fa-camera text-info"></i>
                                            Activities
                                            <small class="percentage" id="activitiesPercentage">0%</small>
                                        </div>
                                        <div class="cost-value"><span id="currencySymbol5">$</span><span id="activitiesCost">0</span></div>
                                    </div>
                                    <div class="cost-item">
                                        <div class="cost-label">
                                            <i class="fa-solid fa-bus text-secondary"></i>
                                            Local Transport
                                            <small class="percentage" id="transportPercentage">0%</small>
                                        </div>
                                        <div class="cost-value"><span id="currencySymbol6">$</span><span id="transportCost">0</span></div>
                                    </div>
                                    <div class="cost-item">
                                        <div class="cost-label">
                                            <i class="fa-solid fa-shield-alt text-dark"></i>
                                            Travel Insurance
                                            <small class="percentage" id="insurancePercentage">0%</small>
                                        </div>
                                        <div class="cost-value"><span id="currencySymbol7">$</span><span id="insuranceCost">0</span></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Chart -->
                            <div class="col-lg-6">
                                <div class="chart-container">
                                    <canvas id="budgetChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Recommendations & Tips -->
                        <div class="row mt-4">
                            <div class="col-lg-6">
                                <div class="recommendations-card">
                                    <h6><i class="fa-solid fa-lightbulb text-warning me-2"></i>Smart Recommendations</h6>
                                    <ul id="recommendationsList" class="list-unstyled">
                                        <!-- Recommendations will be populated here -->
                                    </ul>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="tips-card">
                                    <h6><i class="fa-solid fa-piggy-bank text-success me-2"></i>Money-Saving Tips</h6>
                                    <ul id="savingTipsList" class="list-unstyled">
                                        <!-- Tips will be populated here -->
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- External Data Info -->
                        <div class="external-data-info mt-4" id="externalDataInfo" style="display: none;">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="data-card">
                                        <h6><i class="fa-solid fa-plane me-2"></i>Flight Info</h6>
                                        <p class="mb-1"><strong>Airline:</strong> <span id="airlineInfo">-</span></p>
                                        <p class="mb-1"><strong>Duration:</strong> <span id="flightDuration">-</span></p>
                                        <p class="mb-0"><strong>Stops:</strong> <span id="flightStops">-</span></p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="data-card">
                                        <h6><i class="fa-solid fa-bed me-2"></i>Hotel Info</h6>
                                        <p class="mb-1"><strong>Type:</strong> <span id="hotelName">-</span></p>
                                        <p class="mb-1"><strong>Rating:</strong> <span id="hotelRating">-</span> ‚≠ê</p>
                                        <p class="mb-0"><strong>Amenities:</strong> <span id="hotelAmenities">-</span></p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="data-card">
                                        <h6><i class="fa-solid fa-map me-2"></i>Activities</h6>
                                        <p class="mb-1"><strong>Recommended:</strong> <span id="activityCount">-</span></p>
                                        <p class="mb-0"><strong>Top Activity:</strong> <span id="topActivity">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="text-center mt-4">
                            <% if (typeof currentUser !== 'undefined' && currentUser) { %>
                                <button class="btn btn-success btn-lg me-3" id="saveTripBtn">
                                    <i class="fa-solid fa-save me-2"></i>
                                    Save Trip Plan
                                </button>
                            <% } else { %>
                                <a href="/login" class="btn btn-success btn-lg me-3">
                                    <i class="fa-solid fa-sign-in-alt me-2"></i>
                                    Login to Save Trip
                                </a>
                            <% } %>
                            <button class="btn btn-outline-info btn-lg me-3" id="shareEstimateBtn">
                                <i class="fa-solid fa-share me-2"></i>
                                Share Estimate
                            </button>
                            <button class="btn btn-outline-primary btn-lg" id="planAnotherBtn">
                                <i class="fa-solid fa-plus me-2"></i>
                                Plan Another Trip
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.search-btn {
padding-top: 0.5rem;  
padding-bottom: 0.5rem;
}

.trip-planner-container {
    min-height: 100vh;
    padding: 2rem 0;
}

.planner-header h1 {
    color: var(--text-primary);
    font-weight: 700;
    margin-bottom: 1rem;
}

.trip-form-card {
    background: var(--bg-primary-solid);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 2.5rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color);
}

.form-label {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border-radius: 12px;
    border: 2px solid var(--border-color);
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 0.25rem rgba(254, 66, 77, 0.15);
}

.results-card {
    background: var(--bg-primary-solid);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 2.5rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color);
}

.total-cost {
    background: linear-gradient(135deg, var(--accent-color), #ff6b6b);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    margin: 1rem 0;
}

.total-cost .currency {
    font-size: 2rem;
    font-weight: 300;
}

.total-cost span:not(.currency) {
    font-size: 3rem;
    font-weight: 700;
}

.cost-breakdown {
    background: var(--bg-secondary);
    border-radius: 15px;
    padding: 1.5rem;
}

.cost-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid var(--border-color);
}

.cost-item:last-child {
    border-bottom: none;
}

.cost-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
}

.cost-value {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--accent-color);
}

.percentage {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-left: 0.5rem;
}

.recommendations-card, .tips-card {
    background: rgba(108, 117, 125, 0.05);
    border-radius: 10px;
    padding: 1rem;
    height: 100%;
}

.recommendations-card h6, .tips-card h6 {
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.recommendations-card li, .tips-card li {
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    padding-left: 1rem;
    position: relative;
}

.recommendations-card li:before {
    content: "üí°";
    position: absolute;
    left: 0;
}

.tips-card li:before {
    content: "üí∞";
    position: absolute;
    left: 0;
}

.data-card {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.data-card h6 {
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.loading-steps {
    max-width: 300px;
    margin: 0 auto;
}

#advancedOptions {
    border-top: 1px solid var(--border-color);
    padding-top: 1rem;
    margin-top: 1rem;
}

.seasonal-info {
    margin-top: 0.5rem;
}

.chart-container {
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

@media (max-width: 768px) {
    .trip-form-card, .results-card {
        padding: 1.5rem;
    }
    
    .total-cost span:not(.currency) {
        font-size: 2rem;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('tripPlannerForm');
    const loadingState = document.getElementById('loadingState');
    const resultsSection = document.getElementById('resultsSection');
    let currentEstimation = null;
    let budgetChart = null;

    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').min = today;
    document.getElementById('endDate').min = today;

    // Update end date minimum when start date changes
    document.getElementById('startDate').addEventListener('change', function() {
        document.getElementById('endDate').min = this.value;
    });

    // Advanced options toggle
    document.getElementById('toggleAdvanced').addEventListener('click', function() {
        const advancedOptions = document.getElementById('advancedOptions');
        const isVisible = advancedOptions.style.display !== 'none';
        advancedOptions.style.display = isVisible ? 'none' : 'block';
        this.innerHTML = isVisible ? 
            '<i class="fa-solid fa-cog me-1"></i>Advanced Options' : 
            '<i class="fa-solid fa-times me-1"></i>Hide Advanced';
    });

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
            destination: document.getElementById('destination').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            travelers: parseInt(document.getElementById('travelers').value),
            budgetType: document.getElementById('budgetType').value,
            departureCity: document.getElementById('departureCity').value,
            currency: document.getElementById('currency').value,
            tripType: document.getElementById('tripType').value,
            accommodation: document.getElementById('accommodation')?.value || 'hotel',
            mealPlan: document.getElementById('mealPlan')?.value || 'mixed'
        };

        // Show loading with animated steps
        loadingState.style.display = 'block';
        resultsSection.style.display = 'none';
        
        // Animate loading steps
        const loadingSteps = [
            'üîç Searching for best flight deals...',
            'üè® Finding accommodation options...',
            'üçΩÔ∏è Calculating food & dining costs...',
            'üéØ Analyzing activity prices...',
            'üìä Generating your personalized estimate...'
        ];
        
        let stepIndex = 0;
        const stepInterval = setInterval(() => {
            if (stepIndex < loadingSteps.length) {
                document.getElementById('loadingStep').textContent = loadingSteps[stepIndex];
                document.getElementById('loadingProgress').style.width = `${((stepIndex + 1) / loadingSteps.length) * 100}%`;
                stepIndex++;
            } else {
                clearInterval(stepInterval);
            }
        }, 600);

        try {
            // UI debug log: payload, timestamp, and online status so we can match this request to server logs
            try {
                console.log('UI: Estimate request initiated', {
                    time: new Date().toISOString(),
                    payload: formData,
                    online: navigator.onLine
                });
            } catch (uiLogErr) {
                // ignore logging errors
            }

            const response = await fetch('/trip-planner/api/estimate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            let data = null;
            try {
                data = await response.json();
            } catch (parseErr) {
                console.error('Failed to parse JSON response from estimate API', parseErr);
            }

            if (!response.ok) {
                const msg = (data && (data.error || data.message)) || `Request failed (${response.status})`;
                console.error('Estimate API error:', response.status, msg, data);
                alert('Failed to calculate trip cost: ' + msg);
            } else if (data && data.success) {
                currentEstimation = { ...formData, ...data.estimation };
                displayResults(data.estimation);
            } else {
                // API returned a successful HTTP response but reported failure
                const msg = (data && (data.error || data.message)) || 'Unknown error from estimate service';
                console.error('Estimate API returned unexpected payload', data);
                alert('Failed to calculate trip cost: ' + msg);
            }
        } catch (error) {
            console.error('Error while calling estimate API:', error);
            // Provide more actionable message for network errors
            alert('Failed to calculate trip cost: Network error or server unreachable. Check console for details.');
        } finally {
            loadingState.style.display = 'none';
        }
    });

    function displayResults(estimation) {
        // Update currency symbols
        const currencySymbols = { USD: '$', EUR: '‚Ç¨', GBP: '¬£', INR: '‚Çπ' };
        const symbol = currencySymbols[estimation.currency] || '$';
        
        document.querySelectorAll('[id^="currencySymbol"]').forEach(el => {
            el.textContent = symbol;
        });
        
        // Update cost display
        document.getElementById('totalAmount').textContent = estimation.total.toLocaleString();
        document.getElementById('perPersonAmount').textContent = symbol + estimation.perPerson.toLocaleString();
        document.getElementById('resultTravelers').textContent = estimation.travelers;
        document.getElementById('flightCost').textContent = estimation.costs.flights.toLocaleString();
        document.getElementById('hotelCost').textContent = estimation.costs.hotels.toLocaleString();
        document.getElementById('foodCost').textContent = estimation.costs.food.toLocaleString();
        document.getElementById('activitiesCost').textContent = estimation.costs.activities.toLocaleString();
        document.getElementById('transportCost').textContent = estimation.costs.transport.toLocaleString();
        document.getElementById('insuranceCost').textContent = estimation.costs.insurance.toLocaleString();
        
        // Update percentages
        if (estimation.breakdown) {
            document.getElementById('flightPercentage').textContent = estimation.breakdown.flights + '%';
            document.getElementById('hotelPercentage').textContent = estimation.breakdown.accommodation + '%';
            document.getElementById('foodPercentage').textContent = estimation.breakdown.food + '%';
            document.getElementById('activitiesPercentage').textContent = estimation.breakdown.activities + '%';
            document.getElementById('transportPercentage').textContent = estimation.breakdown.transport + '%';
            document.getElementById('insurancePercentage').textContent = estimation.breakdown.insurance + '%';
        }
        
        // Show seasonal info
        if (estimation.seasonalMultiplier && estimation.seasonalMultiplier > 1.1) {
            const badge = document.getElementById('seasonalBadge');
            badge.style.display = 'inline-block';
            badge.textContent = `Peak season (+${Math.round((estimation.seasonalMultiplier - 1) * 100)}%)`;
        }
        
        // Display recommendations
        const recList = document.getElementById('recommendationsList');
        recList.innerHTML = '';
        if (estimation.recommendations) {
            estimation.recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recList.appendChild(li);
            });
        }
        
        // Display saving tips
        const tipsList = document.getElementById('savingTipsList');
        tipsList.innerHTML = '';
        if (estimation.savingTips) {
            estimation.savingTips.forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                tipsList.appendChild(li);
            });
        }
        
        // Display external data info
        if (estimation.externalData) {
            const externalInfo = document.getElementById('externalDataInfo');
            externalInfo.style.display = 'block';
            
            if (estimation.externalData.flights) {
                document.getElementById('airlineInfo').textContent = estimation.externalData.flights.airline || '-';
                document.getElementById('flightDuration').textContent = estimation.externalData.flights.duration || '-';
                document.getElementById('flightStops').textContent = estimation.externalData.flights.stops === 0 ? 'Direct' : estimation.externalData.flights.stops + ' stop(s)';
            }
            
            if (estimation.externalData.hotels) {
                document.getElementById('hotelName').textContent = estimation.externalData.hotels.hotelName || '-';
                document.getElementById('hotelRating').textContent = estimation.externalData.hotels.rating || '-';
                document.getElementById('hotelAmenities').textContent = estimation.externalData.hotels.amenities?.join(', ') || '-';
            }
            
            if (estimation.externalData.activities) {
                document.getElementById('activityCount').textContent = estimation.externalData.activities.totalActivities || '-';
                document.getElementById('topActivity').textContent = estimation.externalData.activities.recommendedActivities?.[0] || '-';
            }
        }

        // Create/update chart
        const ctx = document.getElementById('budgetChart').getContext('2d');
        
        if (budgetChart) {
            budgetChart.destroy();
        }

        budgetChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Flights', 'Hotels', 'Food', 'Activities', 'Transport', 'Insurance'],
                datasets: [{
                    data: [
                        estimation.costs.flights,
                        estimation.costs.hotels,
                        estimation.costs.food,
                        estimation.costs.activities,
                        estimation.costs.transport,
                        estimation.costs.insurance
                    ],
                    backgroundColor: [
                        '#007bff',
                        '#28a745',
                        '#ffc107',
                        '#17a2b8',
                        '#6c757d',
                        '#343a40'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });

        resultsSection.style.display = 'block';
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // Save trip functionality
    document.getElementById('saveTripBtn')?.addEventListener('click', async function() {
        if (!currentEstimation) return;

        try {
            const response = await fetch('/trip-planner/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tripData: currentEstimation })
            });

            const data = await response.json();
            
            if (data.success) {
                alert('Trip saved successfully!');
                window.location.href = '/trip-planner/my-trips';
            } else {
                alert('Failed to save trip');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to save trip');
        }
    });

    // Reset form
    document.getElementById('resetForm').addEventListener('click', function() {
        form.reset();
        resultsSection.style.display = 'none';
        currentEstimation = null;
        if (budgetChart) {
            budgetChart.destroy();
            budgetChart = null;
        }
    });

    // Plan another trip
    document.getElementById('planAnotherBtn').addEventListener('click', function() {
        form.reset();
        resultsSection.style.display = 'none';
        currentEstimation = null;
        if (budgetChart) {
            budgetChart.destroy();
            budgetChart = null;
        }
        // Reset advanced options
        document.getElementById('advancedOptions').style.display = 'none';
        document.getElementById('toggleAdvanced').innerHTML = '<i class="fa-solid fa-cog me-1"></i>Advanced Options';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    
    // Share estimate functionality
    document.getElementById('shareEstimateBtn')?.addEventListener('click', function() {
        if (!currentEstimation) return;
        
        const shareText = `Check out my trip estimate for ${currentEstimation.destination}!\n` +
                         `${currentEstimation.duration} days for ${currentEstimation.travelers} travelers\n` +
                         `Total cost: ${currencySymbols[currentEstimation.currency] || '$'}${currentEstimation.total.toLocaleString()}\n` +
                         `Plan your trip at: ${window.location.origin}/trip-planner`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Trip Estimate - WanderLust',
                text: shareText,
                url: window.location.href
            }).catch(console.error);
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(shareText).then(() => {
                alert('Trip estimate copied to clipboard!');
            }).catch(() => {
                // Final fallback: show modal with text
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div class="modal fade" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Share Trip Estimate</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <textarea class="form-control" rows="6" readonly>${shareText}</textarea>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                const bootstrapModal = new bootstrap.Modal(modal.querySelector('.modal'));
                bootstrapModal.show();
            });
        }
    });
    
    // Currency symbols for share functionality
    const currencySymbols = { USD: '$', EUR: '‚Ç¨', GBP: '¬£', INR: '‚Çπ' };
});
</script>