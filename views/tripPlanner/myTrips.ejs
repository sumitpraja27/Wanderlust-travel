<% layout("/layouts/boilerplate") %>

<div class="magical-bg-wrapper">
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="trips-header mb-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h2 class="mb-1">
                            <i class="fa-solid fa-suitcase-rolling text-primary me-2"></i>
                            My Trip Plans
                        </h2>
                        <p class="text-muted mb-0">Your saved trips and budget estimates</p>
                    </div>
                    <a href="/trip-planner" class="btn btn-primary">
                        <i class="fa-solid fa-plus me-1"></i>
                        Plan New Trip
                    </a>
                </div>
            </div>

            <!-- Phrase Assistant Widget inserted for quick traveler phrases -->
            <%- include('../phraseAssistant/_widget') %>

            <% if (trips && trips.length > 0) { %>
                <!-- Trip Analytics Dashboard -->
                <div class="analytics-dashboard mb-5">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fa-solid fa-suitcase-rolling text-primary"></i>
                                </div>
                                <div class="stat-content">
                                    <h4><%= analytics.totalTrips %></h4>
                                    <p>Total Trips</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fa-solid fa-dollar-sign text-success"></i>
                                </div>
                                <div class="stat-content">
                                    <h4>$<%= analytics.totalBudget.toLocaleString() %></h4>
                                    <p>Total Budget</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fa-solid fa-wifi-slash text-warning"></i>
                                </div>
                                <div class="stat-content">
                                    <h4 id="offlineTripsCount">0</h4>
                                    <p>Offline Trips</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fa-solid fa-chart-line text-info"></i>
                                </div>
                                <div class="stat-content">
                                    <h4>$<%= analytics.averageTripCost.toLocaleString() %></h4>
                                    <p>Avg Trip Cost</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fa-solid fa-calendar-check text-warning"></i>
                                </div>
                                <div class="stat-content">
                                    <h4><%= analytics.upcomingTrips %></h4>
                                    <p>Upcoming Trips</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Favorite Destinations -->
                    <% if (analytics.favoriteDestinations && analytics.favoriteDestinations.length > 0) { %>
                        <div class="favorite-destinations mt-4">
                            <h5><i class="fa-solid fa-heart text-danger me-2"></i>Favorite Destinations</h5>
                            <div class="row">
                                <% analytics.favoriteDestinations.forEach(dest => { %>
                                    <div class="col-md-4 mb-2">
                                        <div class="destination-badge">
                                            <i class="fa-solid fa-map-marker-alt me-2"></i>
                                            <%= dest.destination %> 
                                            <span class="badge bg-primary ms-2"><%= dest.count %></span>
                                        </div>
                                    </div>
                                <% }) %>
                            </div>
                        </div>
                    <% } %>
                </div>

                <div class="row">
                    <% trips.forEach(trip => { %>
                        <div class="col-lg-6 mb-4">
                            <div class="trip-card">
                                <div class="trip-header">
                                    <div class="trip-destination">
                                        <h4><i class="fa-solid fa-map-marker-alt me-2"></i><%= trip.destination %></h4>
                                        <div class="trip-dates">
                                            <i class="fa-solid fa-calendar me-1"></i>
                                            <%= new Date(trip.startDate).toLocaleDateString() %> - 
                                            <%= new Date(trip.endDate).toLocaleDateString() %>
                                        </div>
                                    </div>
                                    <div class="trip-actions">
                                        <button class="btn btn-sm btn-outline-danger delete-trip-btn" 
                                                data-trip-id="<%= trip._id %>">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="trip-details">
                                    <div class="trip-meta">
                                        <span class="badge bg-primary me-2">
                                            <i class="fa-solid fa-users me-1"></i>
                                            <%= trip.travelers %> travelers
                                        </span>
                                        <span class="badge bg-secondary me-2">
                                            <%= trip.budgetType.charAt(0).toUpperCase() + trip.budgetType.slice(1) %>
                                        </span>
                                        <span class="badge bg-<%= trip.status === 'planned' ? 'warning' : trip.status === 'booked' ? 'info' : 'success' %>">
                                            <%= trip.status.charAt(0).toUpperCase() + trip.status.slice(1) %>
                                        </span>
                                        <% if (new Date(trip.startDate) > new Date()) { %>
                                            <span class="badge bg-success ms-1">
                                                <i class="fa-solid fa-clock me-1"></i>Upcoming
                                            </span>
                                        <% } %>
                                    </div>

                                    <div class="cost-summary mt-3">
                                        <div class="total-cost-display">
                                            <span class="cost-amount">$<%= trip.total.toLocaleString() %></span>
                                            <span class="cost-label">Total Cost</span>
                                        </div>
                                        <div class="per-person-cost">
                                            $<%= Math.round(trip.total / trip.travelers).toLocaleString() %> per person
                                        </div>
                                    </div>

                                    <div class="cost-breakdown-mini mt-3">
                                        <div class="cost-item-mini">
                                            <i class="fa-solid fa-plane text-primary"></i>
                                            $<%= (trip.costs?.flights || 0).toLocaleString() %>
                                        </div>
                                        <div class="cost-item-mini">
                                            <i class="fa-solid fa-bed text-success"></i>
                                            $<%= (trip.costs?.hotels || 0).toLocaleString() %>
                                        </div>
                                        <div class="cost-item-mini">
                                            <i class="fa-solid fa-utensils text-warning"></i>
                                            $<%= (trip.costs?.food || 0).toLocaleString() %>
                                        </div>
                                        <div class="cost-item-mini">
                                            <i class="fa-solid fa-camera text-info"></i>
                                            $<%= (trip.costs?.activities || 0).toLocaleString() %>
                                        </div>
                                    </div>
                                </div>

                                <div class="trip-footer">
                                    <small class="text-muted">
                                        <i class="fa-solid fa-clock me-1"></i>
                                        Planned on <%= new Date(trip.createdAt).toLocaleDateString() %>
                                    </small>
                                    <div class="trip-actions-footer">
                                        <div class="btn-group" role="group">
                                            <a href="/trip-planner/my-trips/<%= trip._id %>" class="btn btn-sm btn-outline-primary">
                                                <i class="fa-solid fa-eye me-1"></i>
                                                View Details
                                            </a>
                                            <button class="btn btn-sm btn-outline-secondary download-trip-btn"
                                                    data-trip-id="<%= trip._id %>"
                                                    data-trip-data="<%= JSON.stringify(trip).replace(/"/g, '"') %>">
                                                <i class="fa-solid fa-download me-1"></i>
                                                Download Offline
                                            </button>
                                            <button class="btn btn-sm btn-outline-success update-status-btn"
                                                    data-trip-id="<%= trip._id %>"
                                                    data-current-status="<%= trip.status %>">
                                                <i class="fa-solid fa-check me-1"></i>
                                                Update Status
                                            </button>
                                            <button class="btn btn-sm btn-outline-info share-trip-btn"
                                                    data-trip-id="<%= trip._id %>">
                                                <i class="fa-solid fa-share me-1"></i>
                                                Share
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            <% } else { %>
                <div class="empty-state text-center py-5">
                    <div class="empty-icon mb-4">
                        <i class="fa-solid fa-route fa-4x text-muted"></i>
                    </div>
                    <h4 class="text-muted mb-3">No Trip Plans Yet</h4>
                    <p class="text-muted mb-4">
                        Start planning your dream vacation with instant budget estimates!
                    </p>
                    <div class="empty-actions">
                        <a href="/trip-planner" class="btn btn-primary btn-lg me-3">
                            <i class="fa-solid fa-plus me-2"></i>
                            Plan Your First Trip
                        </a>
                        <a href="/listings" class="btn btn-outline-primary btn-lg">
                            <i class="fa-solid fa-compass me-2"></i>
                            Explore Destinations
                        </a>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</div>
</div>

<style>
.magical-bg-wrapper {
    min-height: 100vh;
    position: relative;
    overflow: hidden;
    transition: background 0.5s ease;
}

/* Default/Light Theme - Subtle blue overlay merging with beach UI */
.magical-bg-wrapper {
    background: linear-gradient(135deg, rgba(97, 188, 211, 0.4) 0%, rgba(78, 219, 205, 0.3) 50%, rgba(102, 215, 243, 0.2) 100%),
                var(--bg-primary, #f8f9fa);
    --text-primary: #333333;
    --text-secondary: #666666;
    --text-muted: #999999;
    --border-color: rgba(0, 0, 0, 0.1);
    --bg-primary-solid: rgba(255, 255, 255, 0.9);
    --card-bg: rgba(255, 255, 255, 0.95);
    --shadow: rgba(0, 0, 0, 0.1);
    --particle-color: rgba(97, 188, 211, 0.2);
}

.magical-bg-wrapper::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image:
        radial-gradient(circle at 20% 80%, var(--particle-color) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(78, 219, 205, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(102, 215, 243, 0.1) 0%, transparent 50%);
    animation: magical-float 20s ease-in-out infinite;
}

@keyframes magical-float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    33% { transform: translateY(-10px) rotate(120deg); }
    66% { transform: translateY(10px) rotate(240deg); }
}

/* Dark Theme */
[data-theme="dark"] .magical-bg-wrapper {
    background: linear-gradient(135deg, rgba(50, 135, 192, 0.6) 0%, rgba(4, 134, 121, 0.5) 50%, rgba(7, 41, 46, 0.4) 100%),
                var(--bg-primary, #121212);
    --text-primary: #ffffff;
    --text-secondary: #e0e0e0;
    --text-muted: #b0b0b0;
    --border-color: rgba(255, 255, 255, 0.1);
    --bg-primary-solid: rgba(255, 255, 255, 0.1);
    --card-bg: rgba(255, 255, 255, 0.15);
    --shadow: rgba(0, 0, 0, 0.4);
    --particle-color: rgba(50, 135, 192, 0.2);
}

[data-theme="dark"] .magical-bg-wrapper::before {
    background-image:
        radial-gradient(circle at 20% 80%, var(--particle-color) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(4, 134, 121, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(7, 41, 46, 0.1) 0%, transparent 50%);
}

.trip-card {
    background: var(--card-bg);
    backdrop-filter: blur(15px);
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 8px 32px var(--shadow);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    height: 100%;
    position: relative;
    overflow: hidden;
    color: var(--text-primary);
}

.trip-card::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05), transparent);
    animation: shimmer 3s ease-in-out infinite;
    pointer-events: none;
}

@keyframes shimmer {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

[data-theme="dark"] .trip-card::before {
    background: linear-gradient(45deg, transparent, rgba(0, 0, 0, 0.1), transparent);
}

.trip-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px var(--shadow);
    background: rgba(255, 255, 255, 0.2);
}

[data-theme="dark"] .trip-card:hover {
    background: rgba(255, 255, 255, 0.2);
}

.trip-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.trip-destination h4 {
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.trip-dates {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.trip-meta {
    margin-bottom: 1rem;
}
        .search-btn {
        padding-top: 0.5rem;  
        padding-bottom: 0.5rem;
}


.cost-summary {
    background: var(--bg-primary-solid);
    border-radius: 10px;
    padding: 1rem;
    text-align: center;
    border: 1px solid var(--border-color);
}

.cost-amount {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--text-primary);
}

.cost-label {
    display: block;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.per-person-cost {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

.cost-breakdown-mini {
    display: flex;
    justify-content: space-around;
    gap: 0.5rem;
}

.cost-item-mini {
    text-align: center;
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.cost-item-mini i {
    display: block;
    font-size: 1.2rem;
    margin-bottom: 0.25rem;
}

.trip-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.empty-state {
    background: var(--bg-primary-solid);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    margin: 2rem 0;
    padding: 3rem;
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

.analytics-dashboard {
    background: var(--bg-primary-solid);
    backdrop-filter: blur(15px);
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 4px 15px var(--shadow);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

.stat-card {
    background: var(--bg-primary-solid);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
    height: 100%;
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px var(--shadow);
    background: rgba(255, 255, 255, 0.2);
}

[data-theme="dark"] .stat-card:hover {
    background: rgba(255, 255, 255, 0.2);
}

.stat-icon {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.stat-content h4 {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.stat-content p {
    color: var(--text-secondary);
    margin: 0;
    font-size: 0.9rem;
}

.favorite-destinations {
    background: var(--bg-primary-solid);
    border-radius: 10px;
    padding: 1.5rem;
    border: 1px solid var(--border-color);
}

.destination-badge {
    background: var(--bg-primary-solid);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.75rem;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.btn-group .btn {
    font-size: 0.8rem;
    padding: 0.375rem 0.75rem;
}

@media (max-width: 768px) {
    .trip-header {
        flex-direction: column;
        gap: 1rem;
    }

    .cost-breakdown-mini {
        flex-wrap: wrap;
    }

    .trip-footer {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle delete trip
    document.querySelectorAll('.delete-trip-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const tripId = this.dataset.tripId;
            
            if (confirm('Are you sure you want to delete this trip plan?')) {
                try {
                    const response = await fetch(`/trip-planner/${tripId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        location.reload();
                    } else {
                        alert('Failed to delete trip');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to delete trip');
                }
            }
        });
    });
    
    // Handle update trip status
    document.querySelectorAll('.update-status-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const tripId = this.dataset.tripId;
            const currentStatus = this.dataset.currentStatus;
            
            const statusOptions = {
                'planned': 'booked',
                'booked': 'completed',
                'completed': 'planned'
            };
            
            const newStatus = statusOptions[currentStatus];
            const statusLabels = {
                'planned': 'Planned',
                'booked': 'Booked',
                'completed': 'Completed'
            };
            
            if (confirm(`Update trip status to "${statusLabels[newStatus]}"?`)) {
                try {
                    const response = await fetch(`/trip-planner/${tripId}/status`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        location.reload();
                    } else {
                        alert('Failed to update trip status');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to update trip status');
                }
            }
        });
    });
    
    // Handle share trip
    document.querySelectorAll('.share-trip-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tripCard = this.closest('.trip-card');
            const destination = tripCard.querySelector('h4').textContent.replace('ðŸ—ºï¸ ', '');
            const dates = tripCard.querySelector('.trip-dates').textContent.replace('ðŸ“… ', '');
            const totalCost = tripCard.querySelector('.cost-amount').textContent;

            const shareText = `Check out my trip plan!\n` +
                             `ðŸ“ Destination: ${destination}\n` +
                             `ðŸ“… Dates: ${dates}\n` +
                             `ðŸ’° Total Cost: ${totalCost}\n` +
                             `Plan your trip at: ${window.location.origin}/trip-planner`;

            if (navigator.share) {
                navigator.share({
                    title: `Trip to ${destination} - WanderLust`,
                    text: shareText,
                    url: window.location.origin + '/trip-planner'
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('Trip details copied to clipboard!');
                }).catch(() => {
                    alert('Unable to copy to clipboard. Please copy manually:\n\n' + shareText);
                });
            }
        });
    });

    // Handle download trip for offline access
    document.querySelectorAll('.download-trip-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const tripId = this.dataset.tripId;
            const tripDataStr = this.dataset.tripData;

            this.disabled = true;
            this.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Downloading...';

            try {
                let tripData;
                try {
                    tripData = JSON.parse(tripDataStr);
                } catch (e) {
                    throw new Error('Invalid trip data');
                }

                if (window.OfflineManager) {
                    await window.OfflineManager.saveTripForOffline(tripData);
                    this.innerHTML = '<i class="fa-solid fa-check me-1"></i>Downloaded âœ“';
                    this.classList.remove('btn-outline-secondary');
                    this.classList.add('btn-success');

                    // Show toast notification
                    showToast('Trip saved! You can now access it offline.', 'success');
                } else {
                    throw new Error('Offline functionality not available');
                }
            } catch (error) {
                console.error('Download error:', error);
                this.disabled = false;
                this.innerHTML = '<i class="fa-solid fa-download me-1"></i>Download Offline';
                showToast('Failed to download trip for offline access', 'error');
            }
        });
    });

    // Toast notification function
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'error' ? 'danger' : 'warning'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `<i class="fa-solid fa-${type === 'success' ? 'check' : 'error' ? 'times' : 'exclamation'}-circle me-2"></i>${message}`;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
});
</script>